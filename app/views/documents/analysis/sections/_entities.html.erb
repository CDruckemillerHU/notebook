<h5 class="grey-text">Entities</h5>

<script type="text/javascript">
  var color = d3.scalePoint().range(["#EDC951","#CC333F","#00A0B0"]);
  var radarChartOptions = {
    h: 300,
    margin: {
      top: 10, 
      right: 0, 
      bottom: 10, 
      left: 0
    },
    levels: 4,
    maxValue: 100,
    roundStrokes: true,
    color: color,
    dotRadius: 2
  };
</script>

<div class="row">
  <% analysis.document_entities.order('entity_type asc, relevance desc').each do |entity| %>
    <% entity_class = entity.entity_type.constantize %>
    <div class="col s12 m6">
      <div class="card">
        <div class="card-image waves-effect waves-block waves-light">
          <% if entity.entity && entity.entity.image_uploads.any? %>
            <%= image_tag entity.entity.image_uploads.sample.src.url(:large), class: 'activator' %>
          <% else %>
            <%= image_tag 'card-headers/' + entity_class.name.downcase.pluralize + '.jpg', class: 'activator' %>
          <% end %>
        </div>
        <div class="card-content">
          <span class="card-title activator <%= entity_class.color %>-text">
            <i class="material-icons left"><%= entity_class.icon %></i>
            <%= entity.text %>
            <i class="material-icons right black-text">more_vert</i>
          </span>
          <p>
            Relevance score: <%= (entity.relevance * 100).round(1) %>%
            <div class="progress <%= entity_class.color %> lighten-5">
              <div class="determinate <%= entity_class.color %>" style="width: <%= (entity.relevance * 100).round(1) %>%"></div>
            </div>
          </p>
        </div>
        <div class="card-reveal">
          <span class="card-title <%= entity_class.color %>-text">
            <i class="material-icons left"><%= entity_class.icon %></i>
            <%= entity.text %>
            <i class="material-icons right black-text">close</i>
          </span>
          <div class="card-title">Emotional range</div>
          <div id="graph-character-emotions-<%= entity.id %>"></div>
          <ul class="help-text">
            <li>
              Joy: <%= (100 * entity.joy_score ).round(1) %>
              <div class="progress">
                <div class="determinate <%= EmotionService.color_for_emotion(:joy) %>" style="width: <%= (100 * entity.joy_score ).round(1) %>70%"></div>
              </div>
            </li>
            <li>
              Sadness: <%= (100 * entity.sadness_score).round(1) %>
              <div class="progress">
                <div class="determinate <%= EmotionService.color_for_emotion(:sadness) %>" style="width: <%= (100 * entity.sadness_score ).round(1) %>70%"></div>
              </div>
            </li>
            <li>
              Fear: <%= (100 * entity.fear_score).round(1) %>
              <div class="progress">
                <div class="determinate <%= EmotionService.color_for_emotion(:fear) %>" style="width: <%= (100 * entity.fear_score ).round(1) %>70%"></div>
              </div>
            </li>
            <li>
              Disgust: <%= (100 * entity.disgust_score).round(1) %>
              <div class="progress">
                <div class="determinate <%= EmotionService.color_for_emotion(:disgust) %>" style="width: <%= (100 * entity.disgust_score ).round(1) %>70%"></div>
              </div>
            </li>
            <li>
              Anger: <%= (100 * entity.anger_score).round(1) %>
              <div class="progress">
                <div class="determinate <%= EmotionService.color_for_emotion(:anger) %>" style="width: <%= (100 * entity.anger_score ).round(1) %>70%"></div>
              </div>
            </li>
            <li>
              Overall sentiment: <%= entity.sentiment_label %> (<%= (100 * entity.sentiment_score).round(1) %>)
            </li>
          </ul>
        </div>
        <div class="card-action">
          <% if entity.entity_id %>
            <% linked_entity_class = entity.entity.class %>
            <%= link_to polymorphic_path(linked_entity_class.name.downcase, id: entity.entity_id), class: 'blue-text' do %>
              <i class="material-icons left"><%= linked_entity_class.icon %></i>
              View
            <% end %>
            <%= link_to edit_polymorphic_path(linked_entity_class.name.downcase, id: entity.entity_id), class: 'green-text right' do %>
              <i class="material-icons left"><%= linked_entity_class.icon %></i>
              Edit
            <% end %>
          <% else %>
            <%= link_to new_polymorphic_path(entity_class, document_entity: entity.id), class: entity_class.color + '-text' do %>
              <i class="material-icons left">add</i>
              New page
            <% end %>
            <%= link_to '#', class: entity_class.color + '-text right js-link-entity', data: { id: entity.id } do %>
              <i class="material-icons left">link</i>
              Link page
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      $(document).ready(function () {
        var data = [
          [
            { axis: "Joy",     value: <%= (100 * entity.joy_score).round(1) %> },
            { axis: "Sadness", value: <%= (100 * entity.sadness_score).round(1) %> },
            { axis: "Fear",    value: <%= (100 * entity.fear_score).round(1) %> },
            { axis: "Disgust", value: <%= (100 * entity.disgust_score).round(1) %> },
            { axis: "Anger",   value: <%= (100 * entity.anger_score).round(1) %> }
          ]
        ];

        RadarChart("#graph-character-emotions-<%= entity.id %>", data, radarChartOptions);
      });
    </script>

  <% end %>

  <% if analysis.document_entities.where(entity_type: 'Character').any? %>
    <div class="col s12 m6">
      <div class="card">
        <div class="card-content">
          <div class="card-title">Character ensemble emotional spread</div>
          <div id="graph-character-emotions"></div>
        </div>
      </div>
    </div>
    <div class="col s12">
      <div class="card">
        <div class="card-content">
          <div class="card-title">Character emotions</div>
            <table class="highlight">
              <tr>
                <th>Character</th>
                <th>Dominant emotion</th>
                <th>Recessive emotion</th>
              </tr>
              <% analysis.document_entities.where(entity_type: 'Character').each do |character| %>
                <tr>
                  <td><%= character.text %></td>
                  <td>
                    <div class="chip <%= EmotionService.color_for_emotion(character.dominant_emotion.first.first) %> lighten-3">
                      <%= character.dominant_emotion.first.first.to_s.titleize %>
                      (<%= (character.dominant_emotion.first.second * 100).round %>%)
                    </div>
                  </td>
                  <td>
                    <div class="chip <%= EmotionService.color_for_emotion(character.recessive_emotion.first.first) %> lighten-3">
                      <%= character.recessive_emotion.first.first.to_s.titleize %>
                      (<%= (character.recessive_emotion.first.second * 100).round %>%)
                    </div>
                  </td>
                </tr>
              <% end %>
            </table>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<div id="entity-link-modal" class="modal">
  <div class="modal-content">
    <h4>Link an existing page you've created</h4>
    <p>
      You can link a detected entity to one of your already-created pages by selecting it below.
    </p>
    <%= form_with url: link_entity_documents_path do |f| %>
      <%= f.hidden_field :entity_type,        value: nil %>
      <%= f.hidden_field :entity_id,          value: nil %>
      <%= f.hidden_field :document_entity_id, value: nil %>

      <% @current_user_content.each do |content_type, content_list| %>
        <% content_type_class = content_type.constantize %>
        <% next if content_type == 'Document' %>
        <h5><%= content_type.pluralize %></h5>
        <ul class="collection">
          <% content_list.each do |content| %>
            <a href="#" 
               class="<%= content_type_class.color %>-text js-link-entity-selection" 
               data-id="<%= content.id %>"
               data-type="<%= content_type %>">
              <li class="collection-item">
                <i class="material-icons left"><%= content_type_class.icon %></i>
                <%= content.name %>
                <span class="secondary-content">
                  <i class="material-icons">link</i>
                </span>
              </li>
            </a>
          <% end %>
        </ul>
      <% end %>
    <% end %>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancel</a>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function () {

    $('.js-link-entity').click(function () {
      $('#entity-link-modal').find('input[name=document_entity_id]').val($(this).data('id'));

      $('#entity-link-modal').modal('open');

      return false;
    });

    $('.js-link-entity-selection').click(function () {
      var entity = $(this);
      var form   = $(this).closest('form');

      form.find('input[name=entity_id]').val(entity.data('id'));
      form.find('input[name=entity_type]').val(entity.data('type'));
      
      form.submit();
      return false;
    });

    <% if analysis.document_entities.where(entity_type: 'Character').any? %>
      var data = [
        <% analysis.document_entities.where(entity_type: 'Character').each do |entity| %>
          [
            { axis: "Joy",     value: <%= (100 * entity.joy_score).round(1) %> },
            { axis: "Sadness", value: <%= (100 * entity.sadness_score).round(1) %> },
            { axis: "Fear",    value: <%= (100 * entity.fear_score).round(1) %> },
            { axis: "Disgust", value: <%= (100 * entity.disgust_score).round(1) %> },
            { axis: "Anger",   value: <%= (100 * entity.anger_score).round(1) %> }
          ],
        <% end %>
      ];
      /*
        var color = d3.scalePoint()
          .range(["#EDC951","#CC333F","#00A0B0"]);
          
        var radarChartOptions = {
          h: 300,
          margin: {
            top:    30, 
            right:  30, 
            bottom: 30, 
            left:   30
          },
          levels: 3,
          maxValue: 100,
          roundStrokes: true,
          color: color,
          dotRadius: 2
        };
      */
      RadarChart("#graph-character-emotions", data, radarChartOptions);
    <% end %>
  });

</script>
