<%= content_for :full_width_page_header do %>
  <%= render partial: 'content/components/collection_header', locals: { collection: @page_collection } %>
<% end %>

<div class="row">
  <div class="col s12 m9 l8">
    <% if @pages.empty? %>
      <div class="card-panel">
        This collection doesn't have any approved public pages yet. Please check back later!
      </div>
    <% else %>
      <div class="content-sort-bar center">
        <!--
        <%= link_to '#', class: 'btn btn-flat' do %>
          <i class="material-icons left">sort</i>
          Trending
        <% end %>
        -->
        <%= link_to params.permit(:sort).merge({sort: 'alphabetical'}), class: 'btn btn-flat' do %>
          <i class="material-icons left">sort</i>
          Alphabetical
        <% end %>
        <%= link_to params.permit(:sort).merge({sort: 'chronological'}), class: 'btn btn-flat' do %>
          <i class="material-icons left">sort</i>
          Recently added
        <% end %>
      </div>
    <% end %>

    <% @pages.each do |page| %>
      <% content = page.content %>
      <div class="hoverable card horizontal">
        <div class="card-image">
          <%= link_to content do %>
            <%= image_tag content.random_public_image %>
          <% end %>
        </div>
        <div class="card-stacked">
          <div class="card-content">
            <div class="card-title">
              <%= link_to content.name, content %>
            </div>
            <% if page.explanation? %>
              <div>
                <%= simple_format page.explanation %>
              </div>
            <% end %>
            <ul>
              <li class="help-text">
                Submitted by 
                <%= link_to @page_collection.user, class: "#{User.color}-text" do %>
                  <%= image_tag @page_collection.user.image_url(size=20), class: 'left circle', style: 'margin-right: 8px;' %>
                  <%= @page_collection.user.display_name %>
                <% end %>
              </li>
            </ul>
          </div>
        </div>
      </div>
    
    <% end %>
  </div>
  <div class="col s12 m3 l4">
    <% if user_signed_in? %>
      <ul class="collapsible">
        <li>
          <div class="collapsible-header blue white-text">
            <i class="material-icons <%= PageCollection.color %>-text text-darken-2"><%= PageCollection.icon %></i>
            <%= @page_collection.user == current_user ? 'Add' : 'Submit' %> a page
          </div>
          <div class="collapsible-body">
            <%= form_for PageCollectionSubmission.new do |f| %>
              <%= f.hidden_field :page_collection_id, value: @page_collection.id %>
              <div class="input-field">
                <%= f.select :content do %>
                  <% @current_user_content.each do |content_type, content_list| %>
                    <% next unless @page_collection.page_types.include?(content_type) %>
                    <optgroup label="<%= content_type.pluralize %>">
                      <% content_list.each do |content| %>
                        <option value="<%= content_type %>-<%= content.id %>"><%= content.name %></option>
                      <% end %>
                    </optgroup>
                  <% end %>
                <% end %>
                <label>Select a page to <%= @page_collection.user == current_user ? 'add' : 'submit' %></label>
                <div class="helper-text">
                  Only pages you've marked "public" may be submitted.
                </div>
              </div>

              <div class="input-field">
                <%= f.text_area :explanation, class: 'materialize-textarea' %>
                <%= f.label :explanation, 'Optional: add a message' %>
              </div>
              
              <%= f.submit (@page_collection.user == current_user ? 'Add' : 'Submit'), class: "btn #{PageCollection.color} white-text" %>
            <% end %>
          </div>
        </li>
      </ul>
    <% end %>

    <% if user_signed_in? && @page_collection.user == current_user %>
      <div class="card-panel">
        <%= form_for @page_collection do |f| %>
          <div class="input-field">
            <%= f.text_area :description, class: 'materialize-textarea' %>
            <%= f.label :description, 'Collection Description' %>
            <div class="help-text">You can add details for this collection to explain what kinds of pages you'd like it to contain.</div>
          </div>
          <%= f.submit 'Save changes', class: 'btn right blue white-text' %>
          <div class="clearfix"></div>

        <% end %>
      </div>
    <% else %>
      <% if @page_collection.description? %>
        <div class="card-panel">
          <%= simple_format @page_collection.description %>
        </div>
      <% end %>
    <% end %>

    <div class="grey-text uppercase">In this collection</div>
    <div class="collection">
      <% @page_collection.page_types.each do |pt| %>
        <% klass = pt.constantize %>
        <%= link_to('#' + pt, class: "collection-item #{klass.color} white-text") do %>
          <i class="material-icons left"><%= klass.icon %></i>
          <%= pt.pluralize %>
        <% end %>
      <% end %>
    </div>

    <div class="grey-text uppercase">Curator</div>
    <div>
      <%= link_to @page_collection.user, class: "#{User.color}-text" do %>
        <%= image_tag @page_collection.user.image_url(size=20), class: 'left circle', style: 'margin-right: 8px;' %>
        <%= @page_collection.user.display_name %>
      <% end %>
    </div>
    <br />

    <% if @page_collection.contributors.any? %>
      <div class="grey-text uppercase">Contributors</div>
      <% @page_collection.contributors.each do |user| %>
        <div>
          <%= link_to user, class: "#{User.color}-text" do %>
            <%= image_tag user.image_url(size=20), class: 'left circle', style: 'margin-right: 8px;' %>
            <%= user.display_name %>
          <% end %>
        </div>
      <% end %>
      <br />
    <% end %>

    <% if user_signed_in? && current_user == @page_collection.user %>
      <ul>
        <li><%= link_to pluralize(@page_collection.pending_submissions.count, 'pending submission'), page_collection_pending_submissions_path(page_collection_id: @page_collection.id) %></li>
        <li><%= link_to 'Edit this collection', edit_page_collection_path(@page_collection) %></li>
      </ul>
    <% end %>
  </div>
</div>